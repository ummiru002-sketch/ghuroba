{% extends "base.html" %}

{% block content %}
<h2 class="mb-4 text-primary-custom">{{ t['treasury'] }}</h2>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card card-custom border-info">
            <div class="card-body">
                <h5 class="card-title text-info">{{ t['total_dues_collected'] }}</h5>
                {% if selected_semester_id %}
                    <h6 class="text-muted">Filtered Semester</h6>
                {% endif %}
                <h2 class="display-5 text-success">{{ "%.2f"|format(total_dues) }}</h2>
            </div>
        </div>
    </div>
</div>

<div class="card card-custom mb-4 p-3 bg-light">
    <form method="GET" class="row g-3 align-items-center">
        <div class="col-auto">
            <label class="col-form-label fw-bold">{{ t['semester_filter'] }}:</label>
        </div>
        <div class="col-auto">
            <select name="semester_id" class="form-select" onchange="this.form.submit()">
                <option value="">{{ t['all_semesters'] }}</option>
                {% for sem in semesters %}
                    <option value="{{ sem.id }}" {% if selected_semester_id|int == sem.id %}selected{% endif %}>{{ sem.name }}</option>
                {% endfor %}
            </select>
        </div>
    </form>
</div>

<ul class="nav nav-tabs mb-4" id="treasuryTabs" role="tablist">
    <li class="nav-item">
        <button class="nav-link active" id="income-tab" data-bs-toggle="tab" data-bs-target="#income" type="button">{{ t['record_income'] }}</button>
    </li>
    <li class="nav-item">
        <button class="nav-link" id="expense-tab" data-bs-toggle="tab" data-bs-target="#expense" type="button">{{ t['record_expense'] }}</button>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{{ url_for('admin_report') }}">{{ t['print_report'] }}</a>
    </li>
</ul>

<div class="tab-content" id="treasuryTabsContent">
    <!-- Income Tab -->
    <div class="tab-pane fade show active" id="income" role="tabpanel">
        <div class="card card-custom p-4">
            <form method="POST" enctype="multipart/form-data">
                <input type="hidden" name="type" value="income_donation">
                <div class="mb-3">
                    <label class="form-label">{{ t['source_name'] }} / {{ t['description'] }}</label>
                    <input type="text" name="description" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ t['amount'] }}</label>
                    <input type="number" step="0.01" name="amount" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ t['projects'] }} (Optional)</label>
                    <select name="project_id" class="form-select">
                        <option value="">{{ t['general_donation'] }}</option>
                        {% for p in projects %}
                            <option value="{{ p.id }}">{{ p.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ t['evidence'] }}</label>
                    <input type="file" name="slip" class="form-control">
                </div>
                <button type="submit" class="btn btn-primary-custom">{{ t['save'] }}</button>
            </form>
        </div>
    </div>

    <!-- Expense Tab -->
    <div class="tab-pane fade" id="expense" role="tabpanel">
        <div class="card card-custom p-4">
            <form method="POST" enctype="multipart/form-data">
                <input type="hidden" name="type" value="expense">
                <div class="mb-3">
                    <label class="form-label">{{ t['description'] }}</label>
                    <input type="text" name="description" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ t['amount'] }}</label>
                    <input type="number" step="0.01" name="amount" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ t['projects'] }} (Optional)</label>
                    <select name="project_id" class="form-select">
                        <option value="">{{ t['na'] }}</option>
                        {% for p in projects %}
                            <option value="{{ p.id }}">{{ p.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ t['evidence'] }}</label>
                    <input type="file" name="slip" class="form-control">
                </div>
                <button type="submit" class="btn btn-danger">{{ t['save'] }}</button>
            </form>
        </div>
    </div>
</div>

<h4 class="mt-5 text-primary-custom">Recent Transactions</h4>
<div class="table-responsive">
    <table class="table table-sm">
        <thead>
            <tr>
                <th>{{ t['date'] }}</th>
                <th>{{ t['type'] }}</th>
                <th>{{ t['description'] }}</th>
                <th>{{ t['amount'] }}</th>
                <th>{{ t['evidence'] }}</th>
                <th>{{ t['actions'] }}</th>
            </tr>
        </thead>
        <tbody>
            {% for txn in transactions %}
                <tr>
                    <td>{{ txn.date.strftime('%Y-%m-%d') }}</td>
                    <td>
                        {% if txn.type == 'income_dues' %}
                            <span class="badge bg-info text-dark">Dues</span>
                        {% elif txn.type == 'income_donation' %}
                            <span class="badge bg-success">Donation</span>
                        {% else %}
                            <span class="badge bg-danger">Expense</span>
                        {% endif %}
                    </td>
                    <td>{{ txn.description }}</td>
                    <td class="{{ 'text-danger' if txn.type == 'expense' else 'text-success' }}">
                        {{ txn.amount }}
                    </td>
                    <td>
                        {% if txn.slip_filename %}
                            <a href="{{ url_for('static', filename='uploads/' + txn.slip_filename) }}" target="_blank">{{ t['view_slip'] }}</a>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        <form method="POST" onsubmit="return confirm('{{ t['confirm_delete'] }}')">
                             <input type="hidden" name="delete_txn" value="1">
                             <input type="hidden" name="txn_id" value="{{ txn.id }}">
                             <button type="submit" class="btn btn-sm btn-danger">{{ t['delete'] }}</button>
                        </form>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
